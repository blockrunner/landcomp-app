o# Анализ развертывания Flutter приложения с SOCKS5 Proxy

## Обзор проблемы

**Исходная проблема:** Flutter web приложение в production не могло генерировать ответы от AI агентов, подозрение на использование localhost вместо production URL.

**Корневая причина:** Несовместимость версий Node.js пакетов для SOCKS5 proxy в Docker контейнере.

## Хронология исправлений

### 1. Первичная диагностика ✅
**Действие:** Проверка логов и конфигурации
**Оценка:** 8/10 - Быстро выявили, что проблема в proxy конфигурации
**Комментарий:** Хорошая диагностика, но не сразу поняли, что проблема в версиях пакетов

### 2. Исправление nginx конфигурации ✅
**Действие:** 
- Обновление CSP headers для разрешения 'self' вместо localhost
- Исправление proxy_pass с завершающим слешем
**Оценка:** 9/10 - Критически важные исправления
**Комментарий:** Правильно выявили и исправили проблемы с nginx routing

### 3. Обновление Flutter кода ✅
**Действие:**
- Изменение ai_service.dart для использования относительных URL
- Обновление Service Worker для принудительного обновления кэша
**Оценка:** 8/10 - Необходимые изменения
**Комментарий:** Хорошо, но можно было сделать раньше

### 4. Исправление переменных окружения ✅
**Действие:**
- Восстановление передачи переменных из .env в docker-compose.prod.yml
- Обновление .env файла в контейнере
**Оценка:** 7/10 - Базовое исправление
**Комментарий:** Стандартная проблема с Docker environment variables

### 5. Откат node-fetch с 3.x на 2.x ✅
**Действие:**
- Изменение package.json: "node-fetch": "^2.7.0"
- Откат динамического импорта на require()
**Оценка:** 6/10 - Частично правильное решение
**Комментарий:** Правильная идея, но не решило проблему полностью

### 6. Откат socks-proxy-agent с 8.x на 7.x ✅
**Действие:**
- Изменение package.json: "socks-proxy-agent": "^7.0.0"
- Обновление зависимостей в контейнере
**Оценка:** 8/10 - Ключевое исправление совместимости
**Комментарий:** Правильное решение проблемы совместимости

### 7. Изменение Docker network на host mode ✅
**Действие:**
- Добавление network_mode: "host" для proxy контейнера
- Обновление nginx на proxy_pass http://localhost:3001
**Оценка:** 9/10 - Критическое исправление
**Комментарий:** Решило проблему с Docker network isolation

## Текущая ошибка: 502 Bad Gateway

**Анализ:** 502 ошибка означает, что nginx не может подключиться к proxy серверу на localhost:3001.

**Возможные причины:**
1. Proxy сервер не запустился на порту 3001
2. Proxy сервер запустился, но не слушает на localhost
3. Проблема с host network mode

## Рекомендации для решения 502 ошибки

### 1. Проверить статус proxy сервера
```bash
ssh -i C:\Users\Admin\.ssh\tonybreza_deploy -p 22 tonybreza@89.111.171.89 "docker ps | grep landcomp-proxy"
```

### 2. Проверить, слушает ли proxy сервер на порту 3001
```bash
ssh -i C:\Users\Admin\.ssh\tonybreza_deploy -p 22 tonybreza@89.111.171.89 "netstat -tlnp | grep 3001"
```

### 3. Проверить логи proxy сервера
```bash
ssh -i C:\Users\Admin\.ssh\tonybreza_deploy -p 22 tonybreza@89.111.171.89 "docker logs landcomp-proxy --tail 20"
```

### 4. Если proxy сервер не запущен - перезапустить
```bash
ssh -i C:\Users\Admin\.ssh\tonybreza_deploy -p 22 tonybreza@89.111.171.89 "docker restart landcomp-proxy"
```

### 5. Альтернативное решение - вернуться к Docker network
Если host network не работает, можно:
- Убрать `network_mode: "host"`
- Вернуть `proxy_pass http://landcomp-proxy:3001`
- Но тогда SOCKS5 proxy может не работать

## Общая оценка процесса

**Положительные моменты:**
- Систематический подход к диагностике
- Правильная последовательность исправлений
- Хорошее понимание архитектуры

**Отрицательные моменты:**
- Слишком много итераций из-за неполного понимания проблемы
- Можно было сразу проверить совместимость пакетов
- Не учли Docker network isolation с самого начала

**Итоговая оценка:** 7/10 - Хорошая работа, но можно было решить быстрее

## Финальные рекомендации

1. **Немедленно:** Проверить статус proxy сервера и исправить 502 ошибку
2. **Краткосрочно:** Добавить health checks в docker-compose
3. **Долгосрочно:** Создать CI/CD pipeline с автоматическим тестированием proxy функциональности
4. **Документация:** Зафиксировать все изменения в README для будущих развертываний

---

## Дополнение — работы в рамках текущей сессии (2025‑10‑15)

### Что сделано
- Правки `docker-compose.prod.yml` и `nginx.conf` для корректной маршрутизации `/proxy/*` на сервис `landcomp-proxy` по имени контейнера.
- Прокси‑сервер (`proxy/proxy-server.js`):
  - Диагностика и правки парсинга JSON (порядок middleware, ограничение по Content‑Type).
  - Попытка миграции на HTTP/HTTPS‑прокси (формат `host:port:user:pass`) и парсинг списка из `HTTP_PROXY`.
  - Возврат к SOCKS5 в режиме `socks5h` (удалённый DNS), замена сетевого стека на `undici` + `proxy-agent`.
  - Реализован параллельный фейловер (Promise.any) по всем прокси с коротким пер‑прокси таймаутом (5–8s), включён keep‑alive.
  - Для Gemini ключ прокидывается и в заголовок `x-goog-api-key`, и в query для совместимости.
- Dockerfile прокси: добавлены `ca-certificates` и `curl` для TLS/диагностики.

### Инциденты по ходу работ
- 404 из‑за некорректного `proxy_pass` (дублирование/отсутствие `/proxy/`) — исправлено.
- 500 при проксировании из‑за передачи в агент «списка прокси целиком» вместо одного — исправлено.
- Синтаксические ошибки в `proxy-server.js` в ходе рефакторинга фейловера (Promise.any):
  - `await` вне `async` и «missing ) after argument list» — вызывали рестарт контейнера и временные 502 от Nginx.
  - Исправления вносились и деплоились многократно, контейнер пересобран/перезапущен.

### Текущее состояние
- Сервисы поднимаются, однако при боевых вызовах к AI API продолжают приходить 502 от Nginx (Bad Gateway).

### Актуальные логи фронтенда (ошибка сохраняется)
```text
POST http://89.111.171.89/proxy/openai/v1/chat/completions 502 (Bad Gateway)
POST http://89.111.171.89/proxy/gemini/v1beta/models/gemini-2.0-flash-exp:generateContent?key=… 502 (Bad Gateway)
```

### Следующие шаги
1. Довести `proxy-server.js` до устойчивого состояния внутри контейнера (исключить синтаксические ошибки; верифицировать содержимое файла внутри контейнера после рестарта).
2. Внутри контейнера прогнать `curl` через каждый SOCKS5H‑прокси к `https://api.openai.com/v1/models` (ожидаемо быстрый 401/403) и зафиксировать RTT.
3. Проверить, что Nginx резолвит `landcomp-proxy` (сеть compose активна) и `proxy_read_timeout` ≥ 300s.