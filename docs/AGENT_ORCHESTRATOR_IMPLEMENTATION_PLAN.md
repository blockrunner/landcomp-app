# План реализации системы Agent Orchestrator для LandComp AI

## Обзор

Создание централизованной системы управления агентами с динамическим выбором моделей, инструментов и стратегий обработки запросов. Система заменит эвристические методы на ML-подход с поддержкой расширяемости и непрерывного обучения.

## Архитектура

### Центральные компоненты
1. **Agent Orchestrator** - центр принятия решений
2. **Intent Classifier** - классификация намерений
3. **Context Manager** - управление контекстом
4. **Tool Registry** - реестр доступных инструментов
5. **Agent Registry** - реестр агентов
6. **Prompt Enhancer** - улучшение промптов пользователя (опционально)

### Система инструментов
- **Vision Tools**: OpenAI Vision, Gemini Vision
- **Generation Tools**: Text Generation (OpenAI/Gemini), **Image Generation (Gemini только)**
- **Knowledge Tools**: Vector Search, Database Query
- **Analysis Tools**: Entity Extraction, Classification
- **Integration Tools**: External APIs, File Processing
- **MCP Tools**: Model Context Protocol (будущее расширение)

### Правила архитектуры
- Генерация изображений **ТОЛЬКО через Gemini** (текст, изображение или текст+изображение)
- Prompt Enhancement как опция с настройкой в профиле пользователя
- Модульная структура для легкого расширения

## Фазы реализации

### Фаза 1: Базовая инфраструктура (2-3 недели)

#### 1.1 Создание core интерфейсов
- [ ] Создать базовый интерфейс `Agent`
- [ ] Создать базовый интерфейс `Tool`
- [ ] Создать модели данных: `Intent`, `Context`, `AgentRequest`, `AgentResponse`
- [ ] Создать `AgentRegistry` для управления агентами
- [ ] Создать `ToolRegistry` для управления инструментами

#### 1.2 Agent Orchestrator
- [ ] Реализовать базовый `AgentOrchestrator` класс
- [ ] Создать систему маршрутизации запросов
- [ ] Интегрировать с существующим `ChatProvider`
- [ ] Добавить базовое логирование и мониторинг

#### 1.3 Context Manager
- [ ] Создать `ContextManager` для управления контекстом
- [ ] Реализовать сбор контекста из истории сообщений
- [ ] Добавить извлечение контекста из изображений
- [ ] Интегрировать с системой хранения сессий

### Фаза 2: Intent Classification (2-3 недели)

#### 2.1 Создание Intent Classifier
- [ ] Разработать схему классификации намерений (consultation, generation, modification, analysis)
- [ ] Создать датасет для обучения классификатора
- [ ] Интегрировать с OpenAI для классификации намерений
- [ ] Добавить систему уверенности (confidence scoring)

#### 2.2 Entity Extraction
- [ ] Реализовать извлечение сущностей (растения, материалы, условия)
- [ ] Создать словари для основных доменов
- [ ] Интегрировать с Intent Classifier
- [ ] Добавить кэширование результатов

#### 2.3 Context Analysis
- [ ] Реализовать анализ контекста разговора
- [ ] Добавить определение сложности запроса
- [ ] Создать систему определения зависимостей между сообщениями
- [ ] Интегрировать с Vision API для анализа изображений

### Фаза 3: Миграция агентов (2 недели)

#### 3.1 Адаптация существующих агентов
- [ ] Рефакторить `AgentSelector` в модульную систему
- [ ] Создать `VisionAgent` для работы с изображениями
- [ ] Создать `KnowledgeAgent` для текстовых консультаций
- [ ] Создать `GenerationAgent` для генерации изображений (Gemini только)

#### 3.2 Реализация специализированных агентов
- [ ] Создать `GardenerAgent` с расширенными возможностями
- [ ] Создать `LandscapeDesignerAgent`
- [ ] Создать `BuilderAgent`
- [ ] Создать `EcologistAgent`

#### 3.3 Capability System
- [ ] Добавить систему capabilities для агентов
- [ ] Реализовать проверку доступности агентов
- [ ] Создать систему fallback между агентами
- [ ] Добавить метрики производительности агентов

### Фаза 4: Система инструментов (2-3 недели)

#### 4.1 Vision Tools
- [ ] Создать `OpenAIVisionTool` для анализа изображений
- [ ] Создать `GeminiVisionTool` для анализа
- [ ] Создать `GeminiImageGenerationTool` (единственный инструмент генерации)
- [ ] Добавить управление параметрами генерации

#### 4.2 Knowledge Tools
- [ ] Подготовить интеграцию с векторной БД (заглушки)
- [ ] Создать `DatabaseQueryTool` для поиска в локальных данных
- [ ] Создать интерфейс для будущих MCP инструментов
- [ ] Добавить кэширование результатов поиска

#### 4.3 Analysis Tools
- [ ] Создать `EntityExtractionTool`
- [ ] Создать `SentimentAnalysisTool`
- [ ] Создать `ComplexityAnalysisTool`
- [ ] Интегрировать с Intent Classifier

#### 4.4 MCP Tools (Подготовка)
- [ ] Создать базовый интерфейс `MCPTool`
- [ ] Добавить систему регистрации MCP инструментов
- [ ] Подготовить документацию для будущей интеграции
- [ ] Создать примеры конфигурации

### Фаза 5: Prompt Enhancement (1-2 недели)

#### 5.1 Prompt Enhancer Service
- [ ] Создать `PromptEnhancerService` с поддержкой включения/выключения
- [ ] Реализовать улучшение промптов через OpenAI
- [ ] Добавить шаблоны улучшения для разных типов запросов
- [ ] Создать систему кэширования улучшенных промптов

#### 5.2 Настройки пользователя
- [ ] Добавить настройку `enablePromptEnhancement` в профиль
- [ ] Создать UI для включения/выключения в настройках
- [ ] Добавить индикатор когда промпт был улучшен
- [ ] Создать систему сравнения оригинального и улучшенного промпта

#### 5.3 Интеграция
- [ ] Интегрировать Prompt Enhancer в Agent Orchestrator
- [ ] Добавить логику выбора: улучшать или нет
- [ ] Добавить метрики эффективности улучшения
- [ ] Создать fallback при ошибках улучшения

### Фаза 6: Resource Selection (2 недели)

#### 6.1 Model Selection Strategy
- [ ] Создать систему выбора модели на основе контекста
- [ ] Реализовать балансировку качество/скорость/стоимость
- [ ] Добавить правила выбора API (OpenAI vs Gemini)
- [ ] Создать fallback стратегии при недоступности ресурсов

#### 6.2 Parameter Optimization
- [ ] Реализовать динамический выбор параметров (temperature, max_tokens)
- [ ] Создать профили параметров для разных типов запросов
- [ ] Добавить A/B тестирование параметров
- [ ] Оптимизировать на основе обратной связи

#### 6.3 Cost Management
- [ ] Добавить трекинг стоимости API вызовов
- [ ] Создать систему лимитов и квот
- [ ] Реализовать выбор более дешевых альтернатив
- [ ] Добавить отчеты по затратам

### Фаза 7: Tool Orchestration (2-3 недели)

#### 7.1 Execution Engine
- [ ] Создать `ToolExecutionEngine` для выполнения инструментов
- [ ] Реализовать последовательное выполнение
- [ ] Добавить параллельное выполнение инструментов
- [ ] Создать систему зависимостей между инструментами

#### 7.2 Pipeline Builder
- [ ] Создать систему построения пайплайнов обработки
- [ ] Реализовать цепочки инструментов (Tool Chains)
- [ ] Добавить условную логику в пайплайнах
- [ ] Создать предопределенные пайплайны для типичных сценариев

#### 7.3 Error Handling
- [ ] Реализовать graceful degradation при ошибках
- [ ] Создать систему retry с exponential backoff
- [ ] Добавить fallback инструменты
- [ ] Создать детальное логирование ошибок

### Фаза 8: Memory System (2 недели)

#### 8.1 Short-term Memory
- [ ] Реализовать хранение контекста текущего диалога
- [ ] Добавить LRU кэш для недавних запросов
- [ ] Создать систему релевантности контекста
- [ ] Оптимизировать размер сохраняемого контекста

#### 8.2 Medium-term Memory
- [ ] Создать хранилище для предпочтений пользователя
- [ ] Реализовать историю выборов агентов/инструментов
- [ ] Добавить систему паттернов использования
- [ ] Создать персонализацию на основе истории

#### 8.3 Integration с существующей системой
- [ ] Интегрировать с `ChatStorage`
- [ ] Добавить миграцию данных из старой системы
- [ ] Обеспечить обратную совместимость
- [ ] Оптимизировать производительность хранения

### Фаза 9: Feedback & Learning (2-3 недели)

#### 9.1 Feedback System
- [ ] Создать систему сбора обратной связи пользователей
- [ ] Реализовать implicit feedback (время чтения, повторные запросы)
- [ ] Добавить explicit feedback (оценки, исправления)
- [ ] Создать хранилище feedback данных

#### 9.2 Performance Metrics
- [ ] Добавить трекинг времени ответа по этапам
- [ ] Создать метрики качества ответов
- [ ] Реализовать мониторинг затрат
- [ ] Добавить dashboards для анализа

#### 9.3 Adaptive Routing
- [ ] Реализовать динамическую корректировку выбора агентов
- [ ] Создать систему весов на основе производительности
- [ ] Добавить A/B тестирование стратегий
- [ ] Оптимизировать на основе метрик

### Фаза 10: Интеграция и тестирование (2 недели)

#### 10.1 Полная интеграция
- [ ] Заменить старый `_getSmartAIResponse` на Agent Orchestrator
- [ ] Удалить устаревший код и эвристики
- [ ] Обновить все точки входа в систему
- [ ] Провести end-to-end тестирование

#### 10.2 Performance Testing
- [ ] Провести нагрузочное тестирование
- [ ] Оптимизировать узкие места
- [ ] Протестировать все fallback сценарии
- [ ] Валидировать метрики производительности

#### 10.3 User Testing
- [ ] Провести beta-тестирование с пользователями
- [ ] Собрать обратную связь
- [ ] Сравнить с предыдущей версией
- [ ] Внести корректировки на основе feedback

### Фаза 11: Документация и обучение (1 неделя)

#### 11.1 Техническая документация
- [ ] Документировать архитектуру системы
- [ ] Создать API документацию для агентов и инструментов
- [ ] Написать руководство по добавлению новых агентов
- [ ] Создать руководство по добавлению новых инструментов

#### 11.2 Пользовательская документация
- [ ] Обновить документацию по функционалу
- [ ] Создать FAQ по новым возможностям
- [ ] Добавить примеры использования
- [ ] Документировать новые настройки (Prompt Enhancement)

## Структура проекта

```
lib/
├── core/
│   ├── orchestrator/
│   │   ├── agent_orchestrator.dart
│   │   ├── intent_classifier.dart
│   │   ├── context_manager.dart
│   │   ├── resource_selector.dart
│   │   └── tool_executor.dart
│   ├── agents/
│   │   ├── base/
│   │   │   ├── agent.dart
│   │   │   ├── agent_registry.dart
│   │   │   └── agent_response.dart
│   │   ├── vision_agent.dart
│   │   ├── knowledge_agent.dart
│   │   ├── generation_agent.dart
│   │   └── specialized/
│   │       ├── gardener_agent.dart
│   │       ├── landscape_designer_agent.dart
│   │       ├── builder_agent.dart
│   │       └── ecologist_agent.dart
│   ├── tools/
│   │   ├── base/
│   │   │   ├── tool.dart
│   │   │   ├── tool_registry.dart
│   │   │   └── tool_result.dart
│   │   ├── vision/
│   │   │   ├── openai_vision_tool.dart
│   │   │   ├── gemini_vision_tool.dart
│   │   │   └── gemini_image_generation_tool.dart
│   │   ├── knowledge/
│   │   │   ├── vector_search_tool.dart
│   │   │   └── database_query_tool.dart
│   │   ├── analysis/
│   │   │   ├── entity_extraction_tool.dart
│   │   │   └── complexity_analysis_tool.dart
│   │   └── mcp/
│   │       ├── mcp_tool.dart
│   │       └── mcp_registry.dart
│   ├── prompt/
│   │   ├── prompt_enhancer_service.dart
│   │   ├── enhancement_templates.dart
│   │   └── enhancement_cache.dart
│   └── memory/
│       ├── short_term_memory.dart
│       ├── medium_term_memory.dart
│       └── memory_manager.dart
├── features/
│   └── settings/
│       └── presentation/
│           └── pages/
│               └── prompt_enhancement_settings.dart
└── shared/
    ├── models/
    │   ├── intent.dart
    │   ├── context.dart
    │   ├── agent_request.dart
    │   └── execution_plan.dart
    └── utils/
        ├── metrics_tracker.dart
        └── cost_calculator.dart
```

## Ключевые решения

### 1. Генерация изображений
- **ТОЛЬКО Gemini** для генерации
- OpenAI Vision только для анализа
- Единая точка генерации через `GeminiImageGenerationTool`

### 2. Prompt Enhancement
- **Опциональная функция** (по умолчанию выключена)
- Настраивается в профиле пользователя
- Использует OpenAI для улучшения
- Показывает пользователю когда промпт улучшен

### 3. MCP Integration
- **Подготовка инфраструктуры** сейчас
- Базовые интерфейсы и регистрация
- Полная интеграция в будущем
- Plug-and-play архитектура

### 4. Backward Compatibility
- Поэтапная миграция
- Поддержка старого API параллельно
- Feature flags для включения новой системы
- Постепенное удаление legacy кода

## Метрики успеха

### Производительность
- Время принятия решения: < 50ms
- Время полного ответа: < 2s для 90% запросов
- Точность выбора агента: > 95%
- Точность классификации intent: > 90%

### Качество
- User satisfaction: > 4.5/5
- Reduction in "I can't help" responses: < 5%
- Accuracy of generated content: > 85%
- Reduction in irrelevant responses: > 90%

### Масштабируемость
- Support for 10+ agents without degradation
- Support for 50+ tools
- Memory usage: < 500MB base + 50MB per active session
- Throughput: > 100 requests/sec

## Риски и митигация

### Технические риски
1. **Сложность миграции** → Поэтапный подход с feature flags
2. **Производительность классификации** → Кэширование + оптимизация
3. **Интеграция с существующим кодом** → Адаптеры и обратная совместимость

### Бизнес риски
1. **Увеличение затрат на API** → Cost management система
2. **Пользовательский опыт при миграции** → A/B тестирование
3. **Время разработки** → Приоритизация критичных фич

## Временные рамки

**Общая длительность**: 20-25 недель (5-6 месяцев)

**Команда**: 2-3 разработчика + 1 ML инженер (частично)

**Критический путь**: Фазы 1-3 (базовая инфраструктура и миграция агентов)

**Quick Wins**: Фаза 5 (Prompt Enhancement) может быть реализована параллельно
