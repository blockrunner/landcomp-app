# Диаграммы архитектуры прокси-системы

## Текущая архитектура (с проблемами)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           КЛИЕНТСКАЯ СТОРОНА                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐                    ┌──────────────────┐               │
│  │  Flutter Web     │                    │  Flutter Native  │               │
│  │  (браузер)       │                    │  (Android/iOS)   │               │
│  └────────┬─────────┘                    └────────┬─────────┘               │
│           │                                       │                          │
│           │ /proxy/openai/...                    │ http://89.111.171.89:3001│
│           │                                       │                          │
└───────────┼───────────────────────────────────────┼──────────────────────────┘
            │                                       │
            │                                       │
┌───────────▼───────────────────────────────────────▼──────────────────────────┐
│                              СЕРВЕР (Docker)                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                         Nginx Container                           │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  location /proxy/ {                                      │    │       │
│  │  │    proxy_pass http://landcomp-proxy:3001/;             │    │       │
│  │  │  }                                                       │    │       │
│  │  └────────────────────┬─────────────────────────────────────┘    │       │
│  └───────────────────────┼──────────────────────────────────────────┘       │
│                          │                                                    │
│                          │ Internal Docker Network                           │
│                          │                                                    │
│  ┌───────────────────────▼──────────────────────────────────────────┐       │
│  │                    Proxy Server Container                         │       │
│  │                      (Node.js Express)                            │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  - Получает запросы от Nginx                            │    │       │
│  │  │  - Читает SOCKS5 прокси из env (ALL_PROXY)             │    │       │
│  │  │  - Форвардит через SOCKS5 к AI API                     │    │       │
│  │  │                                                          │    │       │
│  │  │  ❌ ПРОБЛЕМЫ:                                           │    │       │
│  │  │     - Нет HEALTHCHECK                                   │    │       │
│  │  │     - HTTP_PROXY="" конфликтует с ALL_PROXY            │    │       │
│  │  │     - Не читает X-Proxy-* headers                      │    │       │
│  │  └──────────────────────┬───────────────────────────────────┘    │       │
│  └─────────────────────────┼──────────────────────────────────────────┘       │
│                            │                                                  │
└────────────────────────────┼──────────────────────────────────────────────────┘
                             │
                             │ Через SOCKS5 прокси
                             │ (может быть недоступен из Docker!)
                             │
┌────────────────────────────▼──────────────────────────────────────────────────┐
│                         ВНЕШНИЕ ПРОКСИ                                         │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐         ┌──────────────────┐                          │
│  │  SOCKS5 Proxy 1  │         │  SOCKS5 Proxy 2  │                          │
│  │  (main)          │         │  (backup)        │                          │
│  └────────┬─────────┘         └────────┬─────────┘                          │
│           │                              │                                    │
└───────────┼──────────────────────────────┼────────────────────────────────────┘
            │                              │
            └──────────────┬───────────────┘
                           │
┌──────────────────────────▼────────────────────────────────────────────────────┐
│                              AI APIs                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐            ┌──────────────────────┐               │
│  │  OpenAI API          │            │  Google Gemini API   │               │
│  │  api.openai.com      │            │  googleapis.com      │               │
│  └──────────────────────┘            └──────────────────────┘               │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘

ПРОБЛЕМЫ ТЕКУЩЕЙ АРХИТЕКТУРЫ:
═══════════════════════════════════════════════════════════════════════════════

1. 🔴 Flutter Web не получает переменные окружения
   - .env генерируется ПОСЛЕ компиляции
   - Скомпилированный JS не может читать runtime .env

2. 🔴 Отсутствие HEALTHCHECK
   - docker-compose.prod.yml требует service_healthy
   - Контейнер не запускается

3. 🔴 Конфликт прокси-переменных
   - HTTP_PROXY="" имеет приоритет над ALL_PROXY
   - Прокси не используется

4. 🟡 SOCKS5 недоступен из Docker
   - Прокси может быть на localhost хоста
   - Docker контейнер не имеет доступа

5. 🟡 Native приложения не могут подключиться
   - Hardcoded IP может быть недоступен
   - Нет fallback механизма

6. 🟡 Избыточная сложность
   - 4 уровня проксирования
   - Каждый уровень = точка отказа
   - Увеличенная латентность
```

---

## Исправленная архитектура (критические ошибки устранены)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           КЛИЕНТСКАЯ СТОРОНА                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐                    ┌──────────────────┐               │
│  │  Flutter Web     │                    │  Flutter Native  │               │
│  │  (браузер)       │                    │  (Android/iOS)   │               │
│  └────────┬─────────┘                    └────────┬─────────┘               │
│           │                                       │                          │
│           │ /proxy/openai/...                    │ http://89.111.171.89:3001│
│           │                                       │                          │
│           │ ✅ Читает window.ENV                  │                          │
│           │    (env.js загружен)                 │                          │
│           │                                       │                          │
└───────────┼───────────────────────────────────────┼──────────────────────────┘
            │                                       │
            │                                       │
┌───────────▼───────────────────────────────────────▼──────────────────────────┐
│                              СЕРВЕР (Docker)                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                         Nginx Container                           │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  - Раздает статические файлы (build/web)               │    │       │
│  │  │  - Генерирует env.js при запуске                       │    │       │
│  │  │  - Проксирует /proxy/* на landcomp-proxy:3001         │    │       │
│  │  │                                                          │    │       │
│  │  │  ✅ ИСПРАВЛЕНО:                                         │    │       │
│  │  │     - env.js генерируется из переменных окружения     │    │       │
│  │  │     - Flutter Web загружает env.js до main.dart.js   │    │       │
│  │  └────────────────────┬─────────────────────────────────────┘    │       │
│  └───────────────────────┼──────────────────────────────────────────┘       │
│                          │                                                    │
│                          │ Internal Docker Network                           │
│                          │                                                    │
│  ┌───────────────────────▼──────────────────────────────────────────┐       │
│  │                    Proxy Server Container                         │       │
│  │                      (Node.js Express)                            │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  - Получает запросы от Nginx                            │    │       │
│  │  │  - Читает прокси: HTTP_PROXY || ALL_PROXY              │    │       │
│  │  │  - Форвардит через SOCKS5 к AI API                     │    │       │
│  │  │  - Имеет /health endpoint                              │    │       │
│  │  │                                                          │    │       │
│  │  │  ✅ ИСПРАВЛЕНО:                                         │    │       │
│  │  │     - Добавлен HEALTHCHECK                             │    │       │
│  │  │     - Правильное чтение переменных (trim + filter)    │    │       │
│  │  │     - Улучшенное логирование                           │    │       │
│  │  └──────────────────────┬───────────────────────────────────┘    │       │
│  └─────────────────────────┼──────────────────────────────────────────┘       │
│                            │                                                  │
└────────────────────────────┼──────────────────────────────────────────────────┘
                             │
                             │ Через SOCKS5 прокси
                             │
┌────────────────────────────▼──────────────────────────────────────────────────┐
│                         ВНЕШНИЕ ПРОКСИ                                         │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐         ┌──────────────────┐                          │
│  │  SOCKS5 Proxy 1  │         │  SOCKS5 Proxy 2  │                          │
│  │  (main)          │         │  (backup)        │                          │
│  └────────┬─────────┘         └────────┬─────────┘                          │
│           │                              │                                    │
└───────────┼──────────────────────────────┼────────────────────────────────────┘
            │                              │
            └──────────────┬───────────────┘
                           │
┌──────────────────────────▼────────────────────────────────────────────────────┐
│                              AI APIs                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐            ┌──────────────────────┐               │
│  │  OpenAI API          │            │  Google Gemini API   │               │
│  │  api.openai.com      │            │  googleapis.com      │               │
│  └──────────────────────┘            └──────────────────────┘               │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘

ЧТО ИСПРАВЛЕНО:
═══════════════════════════════════════════════════════════════════════════════

✅ 1. Flutter Web получает переменные через window.ENV
   - env.js генерируется при запуске nginx
   - Загружается до main.dart.js
   - EnvConfig читает из js_util.getProperty(window, 'ENV')

✅ 2. Добавлен HEALTHCHECK в proxy container
   - Проверяет /health endpoint
   - docker-compose может использовать service_healthy

✅ 3. Исправлено чтение прокси-переменных
   - Правильный приоритет: HTTP_PROXY || ALL_PROXY
   - .trim() и filter для пустых строк

✅ 4. Улучшено логирование
   - Показывает какие переменные используются
   - Маскирует пароли в логах

ОСТАЮЩИЕСЯ ПРОБЛЕМЫ:
═══════════════════════════════════════════════════════════════════════════════

⚠️  1. SOCKS5 доступность из Docker
⚠️  2. Native приложения - hardcoded IP
⚠️  3. Избыточная сложность архитектуры
```

---

## Рекомендуемая архитектура (упрощенная, через Cloudflare Workers)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           КЛИЕНТСКАЯ СТОРОНА                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐                    ┌──────────────────┐               │
│  │  Flutter Web     │                    │  Flutter Native  │               │
│  │  (браузер)       │                    │  (Android/iOS)   │               │
│  └────────┬─────────┘                    └────────┬─────────┘               │
│           │                                       │                          │
│           │ /proxy/openai/...                    │ https://api.landcomp.com │
│           │                                       │                          │
└───────────┼───────────────────────────────────────┼──────────────────────────┘
            │                                       │
            │                                       │
┌───────────▼───────────────────────────────────────▼──────────────────────────┐
│                              СЕРВЕР                                           │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                         Nginx Container                           │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  - Раздает статические файлы                           │    │       │
│  │  │  - Генерирует env.js                                   │    │       │
│  │  │                                                          │    │       │
│  │  │  location /proxy/ {                                     │    │       │
│  │  │    proxy_pass https://api.landcomp.com/;              │    │       │
│  │  │  }                                                       │    │       │
│  │  │                                                          │    │       │
│  │  │  ❌ УБРАЛИ:                                             │    │       │
│  │  │     - Proxy Server контейнер                           │    │       │
│  │  │     - SOCKS5 прокси                                    │    │       │
│  │  │     - Сложную цепочку                                  │    │       │
│  │  └──────────────────────────────────────────────────────────┘    │       │
│  └───────────────────────────────────────────────────────────────────┘       │
│                                                                               │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
                                │ HTTPS (через Cloudflare CDN)
                                │
┌───────────────────────────────▼───────────────────────────────────────────────┐
│                        CLOUDFLARE WORKERS                                     │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  Cloudflare Worker (api.landcomp.com)                            │       │
│  │  ┌──────────────────────────────────────────────────────────┐    │       │
│  │  │  export default {                                        │    │       │
│  │  │    async fetch(request) {                               │    │       │
│  │  │      // Определяем целевой API                         │    │       │
│  │  │      if (path.startsWith('/openai/'))                  │    │       │
│  │  │        target = 'https://api.openai.com'               │    │       │
│  │  │      else if (path.startsWith('/gemini/'))             │    │       │
│  │  │        target = 'https://googleapis.com'               │    │       │
│  │  │                                                          │    │       │
│  │  │      // Форвардим запрос                               │    │       │
│  │  │      return fetch(target + path, options)              │    │       │
│  │  │    }                                                     │    │       │
│  │  │  }                                                       │    │       │
│  │  │                                                          │    │       │
│  │  │  ✅ ПРЕИМУЩЕСТВА:                                       │    │       │
│  │  │     - Глобальный CDN (200+ PoP)                        │    │       │
│  │  │     - Автомасштабирование                              │    │       │
│  │  │     - Встроенная защита DDoS                           │    │       │
│  │  │     - Бесплатный SSL                                   │    │       │
│  │  │     - Низкая латентность                               │    │       │
│  │  │     - Простая отладка                                  │    │       │
│  │  └──────────────────────────────────────────────────────────┘    │       │
│  └───────────────────────────────────────────────────────────────────┘       │
│                                                                               │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
                                │ HTTPS (прямое подключение)
                                │
┌───────────────────────────────▼───────────────────────────────────────────────┐
│                              AI APIs                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐            ┌──────────────────────┐               │
│  │  OpenAI API          │            │  Google Gemini API   │               │
│  │  api.openai.com      │            │  googleapis.com      │               │
│  └──────────────────────┘            └──────────────────────┘               │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘

ПРЕИМУЩЕСТВА НОВОЙ АРХИТЕКТУРЫ:
═══════════════════════════════════════════════════════════════════════════════

✅ Упрощение:
   - 2 уровня вместо 4
   - Меньше точек отказа
   - Проще отладка

✅ Производительность:
   - Глобальный CDN (200+ PoP worldwide)
   - Запросы идут к ближайшему PoP
   - Автоматическое кеширование
   - Низкая латентность

✅ Надежность:
   - Автоматическое масштабирование
   - 99.99% uptime SLA
   - Встроенная защита от DDoS
   - Failover между регионами

✅ Безопасность:
   - Бесплатный SSL/TLS
   - WAF (Web Application Firewall)
   - Rate limiting
   - IP filtering

✅ Стоимость:
   - Бесплатный план: 100,000 запросов/день
   - Нет необходимости в SOCKS5 прокси
   - Нет отдельного proxy-server

✅ Универсальность:
   - Работает для Web и Native
   - Единая точка входа
   - Один URL для всех платформ

МИГРАЦИЯ:
═══════════════════════════════════════════════════════════════════════════════

1. Создать Cloudflare Worker
2. Настроить Custom Domain (api.landcomp.com)
3. Обновить Flutter код (изменить baseUrl)
4. Обновить nginx.conf (proxy_pass на Cloudflare)
5. Удалить landcomp-proxy сервис из docker-compose
6. Тестирование
7. Постепенное переключение (A/B testing)

ОЦЕНКА ВРЕМЕНИ:
═══════════════════════════════════════════════════════════════════════════════

- Настройка Cloudflare Worker: 2-4 часа
- Обновление кода: 4-6 часов
- Тестирование: 1-2 дня
- Migration: 1 день

Итого: 3-5 дней
```

---

## Сравнение архитектур

| Критерий | Текущая | Исправленная | Cloudflare Workers |
|----------|---------|--------------|-------------------|
| **Сложность** | 🔴 Высокая (4 уровня) | 🟡 Средняя (4 уровня) | 🟢 Низкая (2 уровня) |
| **Точек отказа** | 🔴 4 | 🟡 4 | 🟢 2 |
| **Латентность** | 🔴 Высокая | 🟡 Средняя | 🟢 Низкая |
| **Масштабируемость** | 🔴 Ручная | 🟡 Docker Compose | 🟢 Автоматическая |
| **Надежность** | 🔴 Низкая | 🟡 Средняя | 🟢 Высокая (99.99% SLA) |
| **Отладка** | 🔴 Сложная | 🟡 Средняя | 🟢 Простая |
| **Стоимость** | 🟡 SOCKS5 прокси | 🟡 SOCKS5 прокси | 🟢 Бесплатно (до 100K req/day) |
| **Global CDN** | ❌ Нет | ❌ Нет | ✅ Да (200+ PoP) |
| **DDoS защита** | ❌ Нет | ❌ Нет | ✅ Встроенная |
| **SSL/TLS** | 🟡 Через nginx | 🟡 Через nginx | 🟢 Бесплатный |
| **Web поддержка** | 🔴 Не работает | 🟢 Работает | 🟢 Работает |
| **Native поддержка** | 🟡 Hardcoded IP | 🟡 Hardcoded IP | 🟢 Единый URL |
| **Миграция** | - | ✅ Готово | 🟡 3-5 дней |

---

## Рекомендация

### Краткосрочный план (сейчас):
✅ Применить критические исправления  
✅ Запустить в production  
✅ Собрать метрики и логи (1-2 недели)

### Среднесрочный план (1 месяц):
🎯 Мигрировать на Cloudflare Workers  
🎯 Упростить архитектуру  
🎯 Улучшить производительность и надежность

### Долгосрочный план (3-6 месяцев):
📈 Добавить мониторинг и алерты  
📈 Оптимизировать производительность  
📈 Масштабирование по мере роста нагрузки

